#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import json
from time import sleep

import requests


class Api:
    def __init__(self, api_key=None, base_url=None, force=False):
        self.api_key = api_key
        self.base_url = base_url
        self.force = force
        self.headers = {"apikey": self.api_key}
        if api_key is None:
            raise Exception("Please enter your Orion Malware API key.")

    def analyze_hash(self, hash_data):
        results = {}

        try:
            report_id = self.get_report_id_from_hash(hash_data)
            if report_id == '':
                results["error"] = f"No reports for this hash"
                return results
        except Exception as e:
            results["error"] = f"Wrong hash search"
            return results

        try:
            results["report"] = self.get_report_lite(report_id)
            results["report_url"] = self.base_url + "/report/file/" + report_id
        except Exception as e:
            results["error"] = f"Error in report: {str(e)}"
        return results

    def analyze_file(self, filepath: str, filename: str):
        """"""
        results = {}

        with open(filepath, 'rb') as f:
            data = f.read()

        form_data = {'json': json.dumps({
            'filename': filename,
            'client_version': 1,
            'visibility': 'group',
            'force': self.force
        })}
        files_data = {
            'data': (None, data)
        }

        try:
            res = self.submit_task(form_data, files_data)
            if 'task' in res:
                task_id = res['task']['$oid']
            else:
                results["error"] = json.dumps(res)
                return results
        except Exception as e:
            results["error"] = f"Error in upload: {str(e)}"
            return results

        try:
            while not self.status_task(task_id):
                sleep(2)
            report_id = self.get_report_id(task_id)
        except Exception as e:
            results["error"] = f"Error in task status: {str(e)}"
            return results

        try:
            results["report"] = self.get_report_lite(report_id)
            results["report_url"] = self.base_url + "/report/file/" + report_id
        except Exception as e:
            results["error"] = f"Error in report: {str(e)}"

        return results

    def omw_status(self) -> str:
        res = requests.get(self.base_url + '/orion/api/v4.0/status',
                           headers=self.headers).json()
        if res == {}:
            return 'OK'
        else:
            return json.dumps(res)

    def status_task(self, task_id: str) -> bool:
        res = requests.get(self.base_url + '/orion/api/v4.0/tasks/id=' + task_id,
                           headers=self.headers).json()
        if res["task"]["status"] in [0, 1]:
            return False
        return True

    def get_report_id(self, task_id: str) -> str:
        res = requests.get(self.base_url + '/orion/api/v4.0/tasks/id=' + task_id,
                           headers=self.headers).json()
        return res["task"]["report_id"]

    def get_report_lite(self, report_id: str) -> dict:
        return requests.get(self.base_url + '/orion/api/v4.0/filereports/' + report_id + '/overview',
                            headers=self.headers).json()

    def get_report_id_from_hash(self, hash_data: str) -> str:
        res = requests.get(self.base_url + '/orion/api/v4.0/tasks/' + hash_data,
                                 headers=self.headers).json()
        if res and len(res['tasks']) > 0:
            return res['tasks'][0]['report_id']
        return ''

    def submit_task(self, json_data: dict, files_data: dict) -> dict:
        return requests.post(self.base_url + "/orion/api/v4.0/tasks",
                             data=json_data,
                             files=files_data,
                             headers=self.headers).json()
