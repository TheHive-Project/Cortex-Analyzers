#!/usr/bin/env python3
# encoding: utf-8
import re

from cortexutils.extractor import Extractor

from api import Api
from cortexutils.analyzer import Analyzer

def _is_ipv4_address(ip: str):
    try:
        m = re.match(r"^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$", ip)
        return bool(m) and all(map(lambda n: 0 <= int(n) <= 255, m.groups()))
    except Exception:
        return False

class OrionMalwareAnalyzer(Analyzer):
    def __init__(self):
        Analyzer.__init__(self)
        self.service = self.get_param(
            "config.service", None, "Service parameter is missing"
        )
        self.apikey = self.get_param("config.apikey", None,
                                     "Missing Orion Malware API key")
        self.omw_base_url = self.get_param("config.url", None,
                                           "Missing Orion Malware Base url")
        self.force_analyse = self.get_param("config.force", None,
                                            "Missing Orion Malware force parameter")
        self.risk_mapping = {
            'Safe': self.get_param("config.safe", 'safe',
                                            "TheHive risk matching Orion Malware's Safe risk is not set"),
            'Low': self.get_param("config.low", 'info',
                                            "TheHive risk matching Orion Malware's Low risk is not set"),
            'Medium': self.get_param("config.medium", 'suspicious',
                                            "TheHive risk matching Orion Malware's Medium risk is not set"),
            'High': self.get_param("config.high", 'malicious',
                                            "TheHive risk matching Orion Malware's High risk is not set"),
            'Severe': self.get_param("config.severe", 'malicious',
                                            "TheHive risk matching Orion Malware's Severe risk is not set"),
        }

        self.omw_api = Api(self.apikey, self.omw_base_url, self.force_analyse)

    def run(self):
        results = None
        try:
            if self.data_type == "file":
                filename = self.get_param("filename", "file.err")
                filepath = self.get_param("file", None, "File is missing")

                results = self.omw_api.analyze_file(filepath, filename)

            elif self.data_type == "hash":
                hash_data = self.get_param("data", None, "Hash is missing")
                results = self.omw_api.analyze_hash(hash_data)
            else:
                self.error("Invalid data type")

            if results and 'error' in results:
                self.error(results['error'])
            if "report" in results:
                self.report({
                    "results": results
                })
            else:
                self.error("Unexpected error")
        except Exception as e:
            self.error(str(e) + ' : ' + str(results))


    def artifacts(self, raw):
        artifacts_list = []

        # Use the orion custom extractor, if auto_extract setting is not False
        if self.auto_extract:
            orion_report = raw["results"]["report"]['filereport']
            # Extracting basic artifacts
            if orion_report:
                # File ID hash and filename IOCS
                artifacts_list.append(
                    self.build_artifact("filename", orion_report["identification"]["filename"], tags=[]))
                artifacts_list.append(
                    self.build_artifact("hash", orion_report["identification"]["md5"],
                                        tags=["md5"]))
                artifacts_list.append(
                    self.build_artifact("hash", orion_report["identification"]["sha1"],
                                        tags=["sha1"]))
                artifacts_list.append(
                    self.build_artifact("hash", orion_report["identification"]["sha256"],
                                        tags=["sha256"]))

                # Extracting networks lite artifacts
                for net in orion_report["networks"]:
                    net_address = net["address"]
                    # export ip and hostnames
                    if not net_address.startswith("<"):
                        if _is_ipv4_address(net_address):
                             artifacts_list.append(self.build_artifact("ip", net_address, tags=[]))
                        elif '.' in net_address:
                            artifacts_list.append(self.build_artifact("domain", net_address, tags=[]))
                        else:
                            artifacts_list.append(self.build_artifact("hostname", net_address, tags=[]))
        return artifacts_list

    def summary(self, raw):
        taxonomies = []
        namespace = "OrionMalware"
        predicate = "Report"
        try:
            orion_report = raw["results"]["report"]['filereport']
            taxonomies.append(
                self.build_taxonomy(self.risk_mapping[orion_report['risk']['level']],
                                    namespace,
                                    predicate,
                                    orion_report['risk']['level']))
        except Exception as e:
            taxonomies.append(
                self.build_taxonomy('info', namespace, predicate, str(e))
            )
        return {"taxonomies": taxonomies}

if __name__ == "__main__":
    OrionMalwareAnalyzer().run()


